name: Validate Manifests

on:
  pull_request:
    branches: [main]
  push:
    branches: [main]

jobs:
  changed-files:
    runs-on: ubuntu-latest
    outputs:
      yaml_files: ${{ steps.changed.outputs.yaml_files }}
      yaml_any_changed: ${{ steps.changed.outputs.yaml_any_changed }}
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0
      - name: Get changed YAML files
        id: changed
        run: |
          if [ "${{ github.event_name }}" = "push" ]; then
            FILES=$(git diff --name-only HEAD~1 HEAD -- 'base-apps/**/*.yaml' | tr '\n' ' ')
          else
            FILES=$(git diff --name-only origin/main...HEAD -- 'base-apps/**/*.yaml' | tr '\n' ' ')
          fi
          echo "yaml_files=$FILES" >> "$GITHUB_OUTPUT"
          if [ -n "$FILES" ]; then
            echo "yaml_any_changed=true" >> "$GITHUB_OUTPUT"
          else
            echo "yaml_any_changed=false" >> "$GITHUB_OUTPUT"
          fi

  yaml-lint:
    needs: changed-files
    if: needs.changed-files.outputs.yaml_any_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install yamllint
        run: pip install yamllint==1.35.1
      - name: Lint changed YAML files
        run: |
          echo "${{ needs.changed-files.outputs.yaml_files }}" | xargs yamllint -c .yamllint.yaml

  kubernetes-validate:
    needs: changed-files
    if: needs.changed-files.outputs.yaml_any_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Install kubeconform
        run: |
          curl -sL https://github.com/yannh/kubeconform/releases/download/v0.6.7/kubeconform-linux-amd64.tar.gz | tar xz
          sudo mv kubeconform /usr/local/bin/
      - name: Validate changed Kubernetes manifests
        run: |
          echo "${{ needs.changed-files.outputs.yaml_files }}" | xargs kubeconform \
            -summary \
            -strict \
            -ignore-missing-schemas \
            -schema-location default \
            -schema-location 'https://raw.githubusercontent.com/datreeio/CRDs-catalog/main/{{.Group}}/{{.ResourceKind}}_{{.ResourceAPIVersion}}.json' \
            -kubernetes-version 1.33.0

  ingress-policy:
    needs: changed-files
    if: needs.changed-files.outputs.yaml_any_changed == 'true'
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Check ingress IP whitelist on changed files
        run: |
          FAILED=0
          for f in ${{ needs.changed-files.outputs.yaml_files }}; do
            if grep -Pq "kind:\s*Ingress\s*$" "$f"; then
              if ! grep -q 'whitelist-source-range' "$f"; then
                echo "FAIL: $f missing IP whitelist annotation"
                FAILED=1
              fi
            fi
          done
          exit $FAILED
