apiVersion: v1
kind: ConfigMap
metadata:
  name: vault-unseal-script
  namespace: vault
  labels:
    app.kubernetes.io/instance: vault
    app.kubernetes.io/name: vault
data:
  unseal.sh: |
    #!/bin/sh
    set -e

    echo "Waiting for Vault to be ready..."
    until vault status -address=${VAULT_ADDR} > /dev/null 2>&1 || [ $? -eq 2 ]; do
      sleep 2
    done

    echo "Checking Vault seal status..."
    SEALED=$(vault status -address=${VAULT_ADDR} -format=json | grep -o '"sealed":[^,}]*' | awk -F':' '{print $2}')

    if [ "$SEALED" = "true" ]; then
      echo "Vault is sealed. Attempting to unseal..."

      # Unseal with key 1
      if [ -n "$VAULT_UNSEAL_KEY_1" ]; then
        echo "Applying unseal key 1..."
        vault operator unseal -address=${VAULT_ADDR} "$VAULT_UNSEAL_KEY_1"
      fi

      # Unseal with key 2
      if [ -n "$VAULT_UNSEAL_KEY_2" ]; then
        echo "Applying unseal key 2..."
        vault operator unseal -address=${VAULT_ADDR} "$VAULT_UNSEAL_KEY_2"
      fi

      # Unseal with key 3
      if [ -n "$VAULT_UNSEAL_KEY_3" ]; then
        echo "Applying unseal key 3..."
        vault operator unseal -address=${VAULT_ADDR} "$VAULT_UNSEAL_KEY_3"
      fi

      echo "Unseal process completed."
    else
      echo "Vault is already unsealed."
    fi

    # Final status check
    vault status -address=${VAULT_ADDR}
