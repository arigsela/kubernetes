velero:
  # Disable CRD upgrade hook - let Helm install CRDs directly
  upgradeCRDs: false

  # Use existing secret created by Terraform
  credentials:
    useSecret: true
    existingSecret: velero-aws-credentials

  # AWS S3 configuration
  configuration:
    backupStorageLocation:
      - name: default
        provider: aws
        bucket: asela-velero-backups
        config:
          region: us-east-2

    # Disable volume snapshot location (using Kopia file-level backup instead)
    volumeSnapshotLocation: []

    # Enable Kopia for file-level PVC backup (works with local-path storage)
    uploaderType: kopia

    # Default backup TTL (7 days)
    defaultBackupTTL: 168h

  # Install AWS plugin
  initContainers:
    - name: velero-plugin-for-aws
      image: velero/velero-plugin-for-aws:v1.11.0
      imagePullPolicy: IfNotPresent
      volumeMounts:
        - mountPath: /target
          name: plugins

  # Node agent for PVC backups (runs on all nodes including control plane)
  deployNodeAgent: true

  nodeAgent:
    # Allow node-agent to run on control plane nodes
    tolerations:
      - key: node-role.kubernetes.io/control-plane
        operator: Exists
        effect: NoSchedule
      - key: node-role.kubernetes.io/master
        operator: Exists
        effect: NoSchedule

    resources:
      requests:
        cpu: 100m
        memory: 256Mi
      limits:
        cpu: 500m
        memory: 512Mi

  # Velero server resources
  resources:
    requests:
      cpu: 100m
      memory: 128Mi
    limits:
      cpu: 500m
      memory: 512Mi

  # Metrics for monitoring
  metrics:
    enabled: true
    serviceMonitor:
      enabled: false  # Enable if Prometheus Operator is installed
