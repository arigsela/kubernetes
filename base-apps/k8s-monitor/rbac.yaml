---
apiVersion: v1
kind: ServiceAccount
metadata:
  name: eks-monitoring-agent
  labels:
    app: eks-monitoring-agent
  annotations:
    # For EKS IRSA (IAM Roles for Service Accounts)
    # Replace with your IAM role ARN if using IRSA for AWS access
    # eks.amazonaws.com/role-arn: >-
    #   arn:aws:iam::082902060548:role/eks-monitoring-agent-role

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRole
metadata:
  name: eks-monitoring-agent
  labels:
    app: eks-monitoring-agent
rules:
  # Pod operations (read, list for all namespaces)
  - apiGroups: [""]
    resources: ["pods", "pods/log", "pods/status"]
    verbs: ["get", "list", "watch"]

  # Pod deletion (for clearing Failed/Evicted pods)
  - apiGroups: [""]
    resources: ["pods"]
    verbs: ["delete"]

  # Events (for correlation analysis)
  - apiGroups: [""]
    resources: ["events"]
    verbs: ["get", "list", "watch"]

  # Nodes (for capacity planning)
  - apiGroups: [""]
    resources: ["nodes"]
    verbs: ["get", "list"]

  # Namespaces (for discovery)
  - apiGroups: [""]
    resources: ["namespaces"]
    verbs: ["get", "list"]

  # Deployments (read + patch for rolling restarts)
  - apiGroups: ["apps"]
    resources: ["deployments", "deployments/status"]
    verbs: ["get", "list", "watch", "patch", "update"]

  # ReplicaSets and DaemonSets (read-only)
  - apiGroups: ["apps"]
    resources: ["replicasets", "daemonsets", "statefulsets"]
    verbs: ["get", "list", "watch"]

  # ConfigMaps and Secrets (read-only for diagnostics)
  - apiGroups: [""]
    resources: ["configmaps", "secrets"]
    verbs: ["get", "list"]

  # Services (read-only for network analysis)
  - apiGroups: [""]
    resources: ["services", "endpoints"]
    verbs: ["get", "list"]

  # PersistentVolumes (read-only - deletion blocked by hooks)
  - apiGroups: [""]
    resources: ["persistentvolumes", "persistentvolumeclaims"]
    verbs: ["get", "list"]

  # HPA (for autoscaling analysis)
  - apiGroups: ["autoscaling"]
    resources: ["horizontalpodautoscalers"]
    verbs: ["get", "list"]

  # Metrics (for cost optimization)
  - apiGroups: ["metrics.k8s.io"]
    resources: ["pods", "nodes"]
    verbs: ["get", "list"]

---
apiVersion: rbac.authorization.k8s.io/v1
kind: ClusterRoleBinding
metadata:
  name: eks-monitoring-agent
  labels:
    app: eks-monitoring-agent
roleRef:
  apiGroup: rbac.authorization.k8s.io
  kind: ClusterRole
  name: eks-monitoring-agent
subjects:
  - kind: ServiceAccount
    name: eks-monitoring-agent
    namespace: crossplane-eks-monitoring-agent
