---
apiVersion: external-secrets.io/v1beta1
kind: ExternalSecret
metadata:
  name: eks-agent-credentials
  labels:
    app.kubernetes.io/instance: eks-monitoring-agent
    app.kubernetes.io/managed-by: argocd
    app.kubernetes.io/name: eks-monitoring-agent
    app.kubernetes.io/component: secrets
spec:
  # Refresh credentials every 1 minute
  refreshInterval: 1m

  # Reference to ClusterSecretStore
  secretStoreRef:
    kind: ClusterSecretStore
    name: aws-cluster-secrets-store

  # Target Kubernetes Secret to create
  target:
    name: eks-agent-credentials
    creationPolicy: Owner
    template:
      metadata:
        labels:
          app: eks-monitoring-agent

  # Data mappings from AWS Secrets Manager
  data:
    # Required: Anthropic API key
    - secretKey: ANTHROPIC_API_KEY
      remoteRef:
        key: dev-eks/dev/eks-monitoring-agent
        property: anthropic-api-key

    # Required: GitHub Personal Access Token
    - secretKey: GITHUB_PERSONAL_ACCESS_TOKEN
      remoteRef:
        key: dev-eks/dev/eks-monitoring-agent
        property: github-token

    # Optional: Jira integration
    - secretKey: JIRA_URL
      remoteRef:
        key: dev-eks/dev/eks-monitoring-agent
        property: jira-url

    - secretKey: JIRA_USERNAME
      remoteRef:
        key: dev-eks/dev/eks-monitoring-agent
        property: jira-username

    - secretKey: JIRA_API_TOKEN
      remoteRef:
        key: dev-eks/dev/eks-monitoring-agent
        property: jira-api-token

    # Optional: Microsoft Teams webhook
    - secretKey: TEAMS_WEBHOOK_URL
      remoteRef:
        key: dev-eks/dev/eks-monitoring-agent
        property: teams-webhook-url

    # Optional: AWS credentials (only if not using IRSA)
    # Recommended: Use IRSA instead (configure in rbac.yaml ServiceAccount)
    - secretKey: AWS_ACCESS_KEY_ID
      remoteRef:
        key: dev-eks/dev/eks-monitoring-agent
        property: aws-access-key-id

    - secretKey: AWS_SECRET_ACCESS_KEY
      remoteRef:
        key: dev-eks/dev/eks-monitoring-agent
        property: aws-secret-access-key
