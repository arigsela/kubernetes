apiVersion: helm.cattle.io/v1
kind: HelmChartConfig
metadata:
  name: traefik
  namespace: kube-system
spec:
  valuesContent: |-
    # Entry Points Configuration
    ports:
      web:
        port: 8000
        exposedPort: 80
        protocol: TCP
        expose:
          default: true
        # HTTP to HTTPS redirect (chart >=27 expects object with port)
        redirectTo:
          port: websecure
        forwardedHeaders:
          trustedIPs:
            - 10.0.0.0/8
            - 172.16.0.0/12
            - 192.168.0.0/16
            - 173.245.48.0/20    # Cloudflare IP ranges
            - 103.21.244.0/22
            - 103.22.200.0/22
            - 103.31.4.0/22
            - 141.101.64.0/18
            - 108.162.192.0/18
            - 190.93.240.0/20
            - 188.114.96.0/20
            - 197.234.240.0/22
            - 198.41.128.0/17
      websecure:
        port: 8443
        exposedPort: 443
        protocol: TCP
        expose:
          default: true
        tls:
          enabled: true
        forwardedHeaders:
          trustedIPs:
            - 10.0.0.0/8
            - 172.16.0.0/12
            - 192.168.0.0/16
            - 173.245.48.0/20    # Cloudflare IP ranges
            - 103.21.244.0/22
            - 103.22.200.0/22
            - 103.31.4.0/22
            - 141.101.64.0/18
            - 108.162.192.0/18
            - 190.93.240.0/20
            - 188.114.96.0/20
            - 197.234.240.0/22
            - 198.41.128.0/17
        # Add transport timeouts for HTTPS entry point to prevent stream cancellation
        transport:
          respondingTimeouts:
            readTimeout: 60s
            writeTimeout: 30s      # Fix hanging writes causing stream cancellation
            idleTimeout: 120s      # Reduce from 180s for tunnel stability
    
    # API and Dashboard
    api:
      dashboard: true
      insecure: false  # Use HTTPS for dashboard
    
    # Deployment Configuration
    deployment:
      replicas: 3  # Scale to 3 replicas to eliminate single point of failure
    
    # Certificate resolver disabled - using Cloudflare origin certificates
    # certificatesResolvers: {}
    
    # Persistent storage disabled - not using ACME certificates
    # persistence:
    #   enabled: false
    
    # Environment variables (none needed for TLS-ALPN challenge)
    # env: []
    
    # CRITICAL: Configure serversTransport with Cloudflare tunnel optimized timeouts
    serversTransport:
      insecureSkipVerify: true
      maxIdleConnsPerHost: 100
      forwardingTimeouts:
        dialTimeout: 30s
        responseHeaderTimeout: 30s    # CRITICAL FIX: Was 0s (no timeout) causing stream cancellation
        idleConnTimeout: 60s          # Reduce from 90s for tunnel stability  
        readIdleTimeout: 60s          # CRITICAL FIX: Enable HTTP/2 health checks
        pingTimeout: 30s              # Increase from 15s for tunnel latency
    
    # Additional arguments - debug logging for monitoring fix
    additionalArguments:
      - "--accesslog=true"
    
    # Global redirect middleware
    providers:
      kubernetesCRD:
        enabled: true
      kubernetesIngress:
        enabled: true
