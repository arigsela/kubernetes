apiVersion: helm.cattle.io/v1
kind: HelmChartConfig
metadata:
  name: traefik
  namespace: kube-system
spec:
  valuesContent: |-
    # Entry Points Configuration
    ports:
      web:
        port: 8000
        expose: true
        exposedPort: 80
        protocol: TCP
        # HTTP to HTTPS redirect
        redirectTo: websecure
        forwardedHeaders:
          trustedIPs:
            - 10.0.0.0/8
            - 172.16.0.0/12
            - 192.168.0.0/16
            - 173.245.48.0/20    # Cloudflare IP ranges
            - 103.21.244.0/22
            - 103.22.200.0/22
            - 103.31.4.0/22
            - 141.101.64.0/18
            - 108.162.192.0/18
            - 190.93.240.0/20
            - 188.114.96.0/20
            - 197.234.240.0/22
            - 198.41.128.0/17
      websecure:
        port: 8443
        expose: true
        exposedPort: 443
        protocol: TCP
        tls:
          enabled: true
        forwardedHeaders:
          trustedIPs:
            - 10.0.0.0/8
            - 172.16.0.0/12
            - 192.168.0.0/16
            - 173.245.48.0/20    # Cloudflare IP ranges
            - 103.21.244.0/22
            - 103.22.200.0/22
            - 103.31.4.0/22
            - 141.101.64.0/18
            - 108.162.192.0/18
            - 190.93.240.0/20
            - 188.114.96.0/20
            - 197.234.240.0/22
            - 198.41.128.0/17
    
    # API and Dashboard
    api:
      dashboard: true
      insecure: false  # Use HTTPS for dashboard
    
    # ACME Certificate Resolver for Cloudflare DNS Challenge
    certificatesResolvers:
      cloudflare:
        acme:
          email: arigsela@gmail.com 
          storage: /data/acme.json
          dnsChallenge:
            provider: cloudflare
            delayBeforeCheck: 90
            resolvers:
              - "1.1.1.1:53"
              - "8.8.8.8:53"
    
    # Persistent storage for ACME certificates
    persistence:
      enabled: true
      size: 128Mi
      path: /data
      storageClass: local-path  # k3s default storage class
    
    # Environment variables for Cloudflare API
    env:
      - name: CF_DNS_API_TOKEN
        valueFrom:
          secretKeyRef:
            name: cloudflare-api-credentials
            key: apitoken
    
    # Additional configuration for tunnel compatibility
    additionalArguments:
      # Corrected serversTransport flags (timeouts, pooling, TLS verification)
      - "--serversTransport.insecureSkipVerify=true"      # For internal services
      - "--serversTransport.maxIdleConnsPerHost=100"      # Increase connection pool
      - "--serversTransport.dialTimeout=30s"              # Increase dial timeout
      - "--serversTransport.responseHeaderTimeout=10s"    # Response header timeout
      # Temporary debug and access logging for 503 troubleshooting
      - "--log.level=DEBUG"
      - "--accesslog=true"
    
    # Global redirect middleware
    providers:
      kubernetesCRD:
        enabled: true
      kubernetesIngress:
        enabled: true
